<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="description" content="Secure booking and payment for your property rental" />
  <title>Checkout - Book Your Property</title>

  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
    }

    body {
      min-height: 100vh;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      position: relative;
      color: #333;
    }

    body::before {
      content: "";
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23ffffff' fill-opacity='0.05'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
      z-index: 0;
      pointer-events: none;
    }

    .page-wrapper {
      position: relative;
      z-index: 1;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    .container {
      max-width: 1000px;
      width: 100%;
      margin: 0 auto;
      padding: 0 20px;
      flex: 1;
    }

    /* Header */
    header {
      background: rgba(255, 255, 255, 0.98);
      box-shadow: 0px 4px 20px rgba(0, 0, 0, 0.1);
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .header-content {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 16px 0;
    }

    .logo {
      font-size: 24px;
      font-weight: 700;
      color: #667eea;
      text-decoration: none;
    }

    nav a {
      color: #333;
      text-decoration: none;
      margin-left: 30px;
      font-weight: 600;
      transition: color 0.3s ease;
    }

    nav a:hover {
      color: #667eea;
    }

    /* Progress Steps */
    .progress-steps {
      display: flex;
      justify-content: space-between;
      margin: 40px 0;
      position: relative;
    }

    .progress-steps::before {
      content: "";
      position: absolute;
      top: 20px;
      left: 0;
      right: 0;
      height: 2px;
      background: #e0e0e0;
      z-index: -1;
    }

    .step {
      display: flex;
      flex-direction: column;
      align-items: center;
      flex: 1;
    }

    .step-circle {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: white;
      border: 3px solid #e0e0e0;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      color: #999;
      margin-bottom: 10px;
      transition: all 0.3s ease;
    }

    .step.active .step-circle {
      background: #667eea;
      border-color: #667eea;
      color: white;
    }

    .step.completed .step-circle {
      background: #4caf50;
      border-color: #4caf50;
      color: white;
    }

    .step-label {
      font-size: 13px;
      font-weight: 600;
      color: #999;
      text-align: center;
    }

    .step.active .step-label {
      color: white;
    }

    /* Main Content */
    .checkout-container {
      display: grid;
      grid-template-columns: 1fr 380px;
      gap: 30px;
      margin-bottom: 40px;
      animation: slideUp 0.6s ease;
    }

    @keyframes slideUp {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .checkout-form {
      background: white;
      border-radius: 16px;
      padding: 30px;
      box-shadow: 0px 10px 40px rgba(0, 0, 0, 0.15);
    }

    .form-section {
      margin-bottom: 30px;
      padding-bottom: 30px;
      border-bottom: 1px solid #e0e0e0;
    }

    .form-section:last-child {
      border-bottom: none;
      margin-bottom: 0;
    }

    .section-title {
      font-size: 18px;
      font-weight: 700;
      color: #222;
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-group:last-child {
      margin-bottom: 0;
    }

    label {
      display: block;
      font-size: 13px;
      font-weight: 600;
      margin-bottom: 8px;
      color: #333;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    input,
    select,
    textarea {
      width: 100%;
      padding: 12px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 14px;
      font-family: inherit;
      transition: all 0.3s ease;
    }

    input:focus,
    select:focus,
    textarea:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0px 0px 0px 4px rgba(102, 126, 234, 0.1);
    }

    input::placeholder {
      color: #999;
    }

    textarea {
      resize: vertical;
      min-height: 100px;
    }

    /* Two Column Form */
    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
    }

    /* Dates Section */
    .date-picker {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
      align-items: end;
    }

    .date-picker-item {
      display: flex;
      flex-direction: column;
    }

    .nights-display {
      background: #f0f0f0;
      padding: 12px;
      border-radius: 8px;
      text-align: center;
      font-weight: 600;
      color: #667eea;
    }

    /* Order Summary */
    .order-summary {
      background: white;
      border-radius: 16px;
      padding: 25px;
      box-shadow: 0px 10px 40px rgba(0, 0, 0, 0.15);
      height: fit-content;
      position: sticky;
      top: 100px;
    }

    .summary-title {
      font-size: 16px;
      font-weight: 700;
      color: #222;
      margin-bottom: 20px;
    }

    .summary-item {
      display: flex;
      justify-content: space-between;
      margin-bottom: 12px;
      padding-bottom: 12px;
      border-bottom: 1px solid #e0e0e0;
      font-size: 14px;
    }

    .summary-item:last-of-type {
      border-bottom: none;
    }

    .summary-label {
      color: #666;
    }

    .summary-value {
      color: #222;
      font-weight: 600;
    }

    .summary-total {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 16px 0;
      margin: 16px 0;
      border-top: 2px solid #e0e0e0;
      border-bottom: 2px solid #e0e0e0;
      font-size: 18px;
      font-weight: 700;
    }

    .summary-total .total-amount {
      color: #667eea;
    }

    .property-card {
      background: #f9f9f9;
      padding: 12px;
      border-radius: 8px;
      margin-bottom: 20px;
    }

    .property-image {
      width: 100%;
      height: 120px;
      border-radius: 6px;
      object-fit: cover;
      margin-bottom: 10px;
    }

    .property-name {
      font-size: 13px;
      font-weight: 600;
      color: #222;
      margin-bottom: 4px;
    }

    .property-location {
      font-size: 12px;
      color: #999;
    }

    /* Checkbox */
    .checkbox-group {
      display: flex;
      align-items: flex-start;
      gap: 12px;
      margin-bottom: 16px;
    }

    .checkbox-group input[type="checkbox"] {
      width: auto;
      margin-top: 4px;
      cursor: pointer;
      accent-color: #667eea;
    }

    .checkbox-label {
      font-size: 13px;
      color: #666;
      margin: 0;
      line-height: 1.5;
      cursor: pointer;
    }

    .checkbox-label a {
      color: #667eea;
      text-decoration: none;
    }

    .checkbox-label a:hover {
      text-decoration: underline;
    }

    /* Payment Method */
    .payment-methods {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
      gap: 12px;
      margin-bottom: 20px;
    }

    .payment-method {
      position: relative;
    }

    .payment-method input {
      display: none;
    }

    .payment-method label {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 8px;
      padding: 16px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s ease;
      margin: 0;
      text-transform: none;
      letter-spacing: normal;
    }

    .payment-method input:checked + label {
      border-color: #667eea;
      background: rgba(102, 126, 234, 0.05);
    }

    .payment-icon {
      font-size: 24px;
    }

    /* Buttons */
    .button-group {
      display: flex;
      gap: 12px;
      margin-top: 30px;
    }

    .btn {
      padding: 14px 28px;
      border: none;
      border-radius: 10px;
      font-weight: 600;
      font-size: 15px;
      cursor: pointer;
      transition: all 0.3s ease;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      white-space: nowrap;
    }

    .btn-primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      flex: 1;
      justify-content: center;
    }

    .btn-primary:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0px 10px 25px rgba(102, 126, 234, 0.4);
    }

    .btn-secondary {
      background: #f0f0f0;
      color: #333;
    }

    .btn-secondary:hover {
      background: #e0e0e0;
    }

    .btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    /* Modal */
    .modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }

    .modal.show {
      display: flex;
    }

    .modal-content {
      background: white;
      padding: 40px;
      border-radius: 16px;
      text-align: center;
      max-width: 420px;
      width: 90%;
      box-shadow: 0px 20px 60px rgba(0, 0, 0, 0.3);
      animation: slideUp 0.3s ease;
    }

    .modal-icon {
      font-size: 64px;
      margin-bottom: 16px;
    }

    .modal-content h2 {
      font-size: 24px;
      font-weight: 700;
      margin-bottom: 12px;
      color: #4caf50;
    }

    .modal-content p {
      color: #666;
      margin-bottom: 24px;
      line-height: 1.6;
    }

    .booking-ref {
      background: #f0f0f0;
      padding: 12px;
      border-radius: 8px;
      margin-bottom: 20px;
      font-family: monospace;
      font-size: 14px;
      font-weight: 600;
      color: #667eea;
    }

    /* Error Message */
    .error-message {
      background: #fee;
      color: #c33;
      padding: 12px;
      border-radius: 8px;
      margin-bottom: 16px;
      border-left: 4px solid #c33;
      display: none;
    }

    .error-message.show {
      display: block;
    }

    /* Loading Spinner */
    .spinner {
      display: inline-block;
      width: 16px;
      height: 16px;
      border: 2px solid rgba(255, 255, 255, 0.3);
      border-top-color: white;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      margin-right: 8px;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Responsive */
    @media (max-width: 768px) {
      .checkout-container {
        grid-template-columns: 1fr;
      }

      .order-summary {
        position: static;
      }

      .progress-steps {
        flex-wrap: wrap;
        gap: 20px;
      }

      .progress-steps::before {
        display: none;
      }

      .form-row {
        grid-template-columns: 1fr;
      }

      .date-picker {
        grid-template-columns: 1fr;
      }

      nav {
        display: none;
      }
    }

    @media (max-width: 480px) {
      .checkout-form {
        padding: 20px;
      }

      .order-summary {
        padding: 20px;
      }

      .section-title {
        font-size: 16px;
      }

      .button-group {
        flex-direction: column;
      }

      .payment-methods {
        grid-template-columns: repeat(2, 1fr);
      }
    }
  </style>
</head>

<body>
  <div class="page-wrapper">
    <!-- Header -->
    <header>
      <div class="container">
        <div class="header-content">
          <a href="index.html" class="logo">üè† Cytti Homes</a>
          <nav>
            <a href="index.html">Home</a>
            <a href="properties.html">Properties</a>
          </nav>
        </div>
      </div>
    </header>

    <!-- Progress Steps -->
    <div class="container">
      <div class="progress-steps">
        <div class="step completed">
          <div class="step-circle">1</div>
          <div class="step-label">Select Property</div>
        </div>
        <div class="step active">
          <div class="step-circle">2</div>
          <div class="step-label">Payment Details</div>
        </div>
        <div class="step">
          <div class="step-circle">3</div>
          <div class="step-label">Confirmation</div>
        </div>
      </div>
    </div>

    <!-- Main Content -->
    <div class="container">
      <div class="checkout-container">
        <!-- Booking Form -->
        <div class="checkout-form">
          <form id="bookingForm" novalidate>
            <!-- Property Info -->
            <div class="form-section">
              <div class="section-title">üìç Property Details</div>
              <div id="propertyInfo"></div>
            </div>

            <!-- Guest Information -->
            <div class="form-section">
              <div class="section-title">üë§ Your Details</div>

              <div class="form-row">
                <div class="form-group">
                  <label for="firstName">First Name *</label>
                  <input type="text" id="firstName" name="firstName" required placeholder="John" />
                </div>
                <div class="form-group">
                  <label for="lastName">Last Name *</label>
                  <input type="text" id="lastName" name="lastName" required placeholder="Doe" />
                </div>
              </div>

              <div class="form-group">
                <label for="email">Email Address *</label>
                <input type="email" id="email" name="email" required placeholder="your@email.com" />
              </div>

              <div class="form-group">
                <label for="phone">Phone Number *</label>
                <input type="tel" id="phone" name="phone" required placeholder="+254 712 345 678" />
              </div>

              <div class="form-group">
                <label for="country">Country *</label>
                <select id="country" name="country" required>
                  <option value="">Select Country</option>
                  <option value="Kenya">Kenya</option>
                  <option value="Uganda">Uganda</option>
                  <option value="Tanzania">Tanzania</option>
                  <option value="Rwanda">Rwanda</option>
                  <option value="Other">Other</option>
                </select>
              </div>
            </div>

            <!-- Dates -->
            <div class="form-section">
              <div class="section-title">üìÖ Check-In & Check-Out</div>

              <div class="date-picker">
                <div class="date-picker-item">
                  <label for="checkIn">Check-In *</label>
                  <input type="date" id="checkIn" name="checkIn" required />
                </div>
                <div class="date-picker-item">
                  <label for="checkOut">Check-Out *</label>
                  <input type="date" id="checkOut" name="checkOut" required />
                </div>
              </div>

              <div style="margin-top: 15px;">
                <div class="nights-display">
                  <span id="nightsCount">0</span> nights
                </div>
              </div>
            </div>

            <!-- Special Requests -->
            <div class="form-section">
              <div class="section-title">üí¨ Special Requests</div>

              <div class="form-group">
                <label for="requests">Additional Information (Optional)</label>
                <textarea id="requests" name="requests" placeholder="Any special requests or information for the host..."></textarea>
              </div>
            </div>

            <!-- Payment Method -->
            <div class="form-section">
              <div class="section-title">üí≥ Payment Method</div>

              <div class="payment-methods">
                <div class="payment-method">
                  <input type="radio" id="mpesa" name="paymentMethod" value="mpesa" required checked />
                  <label for="mpesa">
                    <span class="payment-icon">üì±</span>
                    <span>M-Pesa</span>
                  </label>
                </div>
                <div class="payment-method">
                  <input type="radio" id="card" name="paymentMethod" value="card" required />
                  <label for="card">
                    <span class="payment-icon">üí≥</span>
                    <span>Card</span>
                  </label>
                </div>
                <div class="payment-method">
                  <input type="radio" id="bank" name="paymentMethod" value="bank" required />
                  <label for="bank">
                    <span class="payment-icon">üè¶</span>
                    <span>Bank</span>
                  </label>
                </div>
              </div>

              <!-- M-Pesa Phone -->
              <div id="mpesaFields" class="form-group">
                <label for="mpesaPhone">M-Pesa Phone Number *</label>
                <input type="tel" id="mpesaPhone" name="mpesaPhone" placeholder="254712345678" />
              </div>

              <!-- Card Fields (Hidden by default) -->
              <div id="cardFields" style="display: none;">
                <div class="form-group">
                  <label for="cardNumber">Card Number *</label>
                  <input type="text" id="cardNumber" name="cardNumber" placeholder="4111 1111 1111 1111" maxlength="19" />
                </div>

                <div class="form-row">
                  <div class="form-group">
                    <label for="cardExpiry">Expiry Date *</label>
                    <input type="text" id="cardExpiry" name="cardExpiry" placeholder="MM/YY" maxlength="5" />
                  </div>
                  <div class="form-group">
                    <label for="cardCVC">CVC *</label>
                    <input type="text" id="cardCVC" name="cardCVC" placeholder="123" maxlength="3" />
                  </div>
                </div>
              </div>
            </div>

            <!-- Agreements -->
            <div class="form-section">
              <div class="checkbox-group">
                <input type="checkbox" id="terms" name="terms" required />
                <label for="terms" class="checkbox-label">
                  I agree to the <a href="terms.html">Terms & Conditions</a> and <a href="privacy.html">Privacy Policy</a>
                </label>
              </div>

              <div class="checkbox-group">
                <input type="checkbox" id="cancellation" name="cancellation" />
                <label for="cancellation" class="checkbox-label">
                  I understand the <a href="cancellation.html">cancellation policy</a> for this property
                </label>
              </div>
            </div>

            <!-- Error Message -->
            <div class="error-message" id="errorMessage"></div>

            <!-- Submit Button -->
            <div class="button-group">
              <a href="properties.html" class="btn btn-secondary">‚Üê Back</a>
              <button type="submit" class="btn btn-primary" id="submitBtn">
                Complete Booking
              </button>
            </div>
          </form>
        </div>

        <!-- Order Summary -->
        <div class="order-summary">
          <div class="summary-title">Booking Summary</div>

          <div id="summaryProperty"></div>

          <div class="summary-item">
            <span class="summary-label">Check-In</span>
            <span class="summary-value" id="summaryCheckIn">-</span>
          </div>

          <div class="summary-item">
            <span class="summary-label">Check-Out</span>
            <span class="summary-value" id="summaryCheckOut">-</span>
          </div>

          <div class="summary-item">
            <span class="summary-label">Nights</span>
            <span class="summary-value" id="summaryNights">0</span>
          </div>

          <div class="summary-item">
            <span class="summary-label">Price per Night</span>
            <span class="summary-value" id="summaryPrice">KSh 0</span>
          </div>

          <div class="summary-item">
            <span class="summary-label">Subtotal</span>
            <span class="summary-value" id="summarySubtotal">KSh 0</span>
          </div>

          <div class="summary-item">
            <span class="summary-label">Service Fee (10%)</span>
            <span class="summary-value" id="summaryFee">KSh 0</span>
          </div>

          <div class="summary-item">
            <span class="summary-label">Tax (16%)</span>
            <span class="summary-value" id="summaryTax">KSh 0</span>
          </div>

          <div class="summary-total">
            <span>Total Amount</span>
            <span class="total-amount" id="summaryTotal">KSh 0</span>
          </div>

          <div style="background: #f0f0f0; padding: 12px; border-radius: 8px; font-size: 12px; color: #666; text-align: center;">
            ‚úì Secure Payment Powered by Cytti Homes
          </div>
        </div>
      </div>
    </div>

    <!-- Success Modal -->
    <div class="modal" id="successModal">
      <div class="modal-content">
        <div class="modal-icon">‚úì</div>
        <h2>Booking Confirmed!</h2>
        <p>Your property booking has been confirmed. Check your email for booking details.</p>
        <div class="booking-ref" id="bookingRef">REF: #00000000</div>
        <div class="summary-item" style="border: none; justify-content: center; margin: 0;">
          <span style="color: #666;">Confirmation sent to <strong id="confirmEmail">your@email.com</strong></span>
        </div>
        <div class="button-group" style="margin-top: 24px;">
          <a href="index.html" class="btn btn-primary" style="flex: 1;">
            Back to Home
          </a>
        </div>
      </div>
    </div>

    <!-- Footer -->
    <footer style="background: rgba(255, 255, 255, 0.95); padding: 30px 0; margin-top: 60px; border-top: 1px solid #e0e0e0;">
      <div class="container" style="text-align: center; color: #999; font-size: 14px;">
        <p>&copy; 2026 Cytti Homes. All rights reserved.</p>
      </div>
    </footer>
  </div>

  <script>
    // State management
    const state = {
      propertyId: null,
      propertyPrice: null,
      propertyData: null,
      nights: 0,
      formData: {}
    };

    // Get URL parameters
    const params = new URLSearchParams(window.location.search);
    state.propertyId = params.get('property');
    state.propertyPrice = parseInt(params.get('price')) || 0;

    // DOM Elements
    const bookingForm = document.getElementById('bookingForm');
    const checkInInput = document.getElementById('checkIn');
    const checkOutInput = document.getElementById('checkOut');
    const mpesaRadio = document.getElementById('mpesa');
    const cardRadio = document.getElementById('card');
    const bankRadio = document.getElementById('bank');
    const cardFields = document.getElementById('cardFields');
    const mpesaFields = document.getElementById('mpesaFields');
    const submitBtn = document.getElementById('submitBtn');
    const errorMessage = document.getElementById('errorMessage');

    // Initialize
    window.addEventListener('DOMContentLoaded', () => {
      setupEventListeners();
      loadPropertyData();
      setMinCheckInDate();
    });

    // Setup event listeners
    function setupEventListeners() {
      checkInInput.addEventListener('change', calculateNights);
      checkOutInput.addEventListener('change', calculateNights);

      mpesaRadio.addEventListener('change', togglePaymentFields);
      cardRadio.addEventListener('change', togglePaymentFields);
      bankRadio.addEventListener('change', togglePaymentFields);

      bookingForm.addEventListener('submit', handleSubmit);
    }

    // Load property data
    async function loadPropertyData() {
      if (!state.propertyId) {
        showError('No property selected');
        return;
      }

      try {
        const response = await fetch(`get_property_details.php?id=${encodeURIComponent(state.propertyId)}`, {
          headers: { 'X-Requested-With': 'XMLHttpRequest' }
        });

        if (!response.ok) throw new Error('Failed to load property');

        const property = await response.json();
        state.propertyData = property;

        displayPropertyInfo(property);
      } catch (error) {
        console.error('Error:', error);
        showError('Failed to load property details');
      }
    }

    // Display property info
    function displayPropertyInfo(property) {
      const propertyHtml = `
        <div class="property-card">
          <img src="${property.image || 'placeholder.png'}" alt="${property.title}" class="property-image">
          <div class="property-name">${property.title}</div>
          <div class="property-location">üìç ${property.location || 'Location'}</div>
        </div>
      `;

      document.getElementById('propertyInfo').innerHTML = propertyHtml;
      document.getElementById('summaryProperty').innerHTML = propertyHtml;
      document.getElementById('summaryPrice').textContent = `KSh ${formatPrice(state.propertyPrice)}`;
    }

    // Calculate nights and price
    function calculateNights() {
      const checkIn = new Date(checkInInput.value);
      const checkOut = new Date(checkOutInput.value);

      if (checkIn && checkOut && checkOut > checkIn) {
        const diffTime = checkOut - checkIn;
        state.nights = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

        updateSummary();
      }
    }

    // Update summary
    function updateSummary() {
      const subtotal = state.propertyPrice * state.nights;
      const serviceFee = Math.floor(subtotal * 0.10);
      const tax = Math.floor(subtotal * 0.16);
      const total = subtotal + serviceFee + tax;

      document.getElementById('nightsCount').textContent = state.nights;
      document.getElementById('summaryCheckIn').textContent = checkInInput.value ? new Date(checkInInput.value).toLocaleDateString() : '-';
      document.getElementById('summaryCheckOut').textContent = checkOutInput.value ? new Date(checkOutInput.value).toLocaleDateString() : '-';
      document.getElementById('summaryNights').textContent = state.nights;
      document.getElementById('summarySubtotal').textContent = `KSh ${formatPrice(subtotal)}`;
      document.getElementById('summaryFee').textContent = `KSh ${formatPrice(serviceFee)}`;
      document.getElementById('summaryTax').textContent = `KSh ${formatPrice(tax)}`;
      document.getElementById('summaryTotal').textContent = `KSh ${formatPrice(total)}`;
    }

    // Toggle payment fields
    function togglePaymentFields() {
      if (cardRadio.checked) {
        cardFields.style.display = 'block';
        mpesaFields.style.display = 'none';
        document.getElementById('cardNumber').required = true;
        document.getElementById('mpesaPhone').required = false;
      } else if (mpesaRadio.checked) {
        cardFields.style.display = 'none';
        mpesaFields.style.display = 'block';
        document.getElementById('cardNumber').required = false;
        document.getElementById('mpesaPhone').required = true;
      } else {
        cardFields.style.display = 'none';
        mpesaFields.style.display = 'none';
        document.getElementById('cardNumber').required = false;
        document.getElementById('mpesaPhone').required = false;
      }
    }

    // Form submission
    async function handleSubmit(e) {
      e.preventDefault();

      if (!validateForm()) {
        return;
      }

      submitBtn.disabled = true;
      submitBtn.innerHTML = '<span class="spinner"></span>Processing...';

      try {
        const formData = new FormData(bookingForm);
        formData.append('propertyId', state.propertyId);
        formData.append('nights', state.nights);
        formData.append('totalPrice', calculateTotal());

        const response = await fetch('payment_process.php', {
          method: 'POST',
          body: formData,
          headers: { 'X-Requested-With': 'XMLHttpRequest' }
        });

        const data = await response.json();

        if (data.success) {
          showSuccessModal(data);
        } else {
          showError(data.message || 'Booking failed. Please try again.');
          submitBtn.disabled = false;
          submitBtn.innerHTML = 'Complete Booking';
        }
      } catch (error) {
        console.error('Error:', error);
        showError('Network error. Please try again.');
        submitBtn.disabled = false;
        submitBtn.innerHTML = 'Complete Booking';
      }
    }

    // Validate form
    function validateForm() {
      const firstName = document.getElementById('firstName').value.trim();
      const lastName = document.getElementById('lastName').value.trim();
      const email = document.getElementById('email').value.trim();
      const phone = document.getElementById('phone').value.trim();
      const checkIn = checkInInput.value;
      const checkOut = checkOutInput.value;
      const terms = document.getElementById('terms').checked;

      if (!firstName || !lastName) {
        showError('Please enter your full name');
        return false;
      }

      const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      if (!emailRegex.test(email)) {
        showError('Please enter a valid email address');
        return false;
      }

      if (!phone || phone.length < 10) {
        showError('Please enter a valid phone number');
        return false;
      }

      if (!checkIn || !checkOut) {
        showError('Please select check-in and check-out dates');
        return false;
      }

      if (state.nights <= 0) {
        showError('Check-out date must be after check-in date');
        return false;
      }

      if (!terms) {
        showError('Please agree to the terms and conditions');
        return false;
      }

      return true;
    }

    // Utility functions
    function formatPrice(price) {
      return parseInt(price).toLocaleString('en-KE');
    }

    function calculateTotal() {
      const subtotal = state.propertyPrice * state.nights;
      const serviceFee = Math.floor(subtotal * 0.10);
      const tax = Math.floor(subtotal * 0.16);
      return subtotal + serviceFee + tax;
    }

    function setMinCheckInDate() {
      const today = new Date();
      const minDate = today.toISOString().split('T')[0];
      checkInInput.min = minDate;
    }

    function showError(message) {
      errorMessage.textContent = message;
      errorMessage.classList.add('show');
      setTimeout(() => errorMessage.classList.remove('show'), 5000);
    }

    function showSuccessModal(data) {
      document.getElementById('confirmEmail').textContent = document.getElementById('email').value;
      document.getElementById('bookingRef').textContent = `REF: #${data.bookingId || 'BOOKING123'}`;
      document.getElementById('successModal').classList.add('show');
    }
  </script>
</body>
</html>